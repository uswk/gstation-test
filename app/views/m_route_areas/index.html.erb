<% content_for :head do %>
  <meta name="turbo-prefetch" content="false">
<% end %>
<% content_for :js do %>
  <%= javascript_include_tag "common" %>
<% end %>

<h1>収集区内エリア一覧画面</h1>

収集区名：<%= @m_route.route_name  %>
<% if not @map_zenrin_cid.blank? %>
  <input type=button value="ゼンリン住宅地図" class='btn' style="position:relative; top:0px; left:-10px; float: right;" onclick=fzenrin_common_map_display("<%= root_url(only_path: false) %>");>
<% end %>
<br><br>
<table border=1>
  <tr>
    <td valign=top width=20%>
      <table>
        <thead>
          <tr>
            <th>No.</th>
            <% if current_user.authority!=9 %>
              <th></th>
              <th></th>
            <% end %>
          </tr>
        </thead>
        <tbody>
          <% @m_route_areas.each do |m_route_area| %>
            <tr onClick="mClickTR(this, '<%= m_route_area.tree_no %>');" onmouseover="mouseOverTR(this);" onmouseout="mouseOutTR(this);">
              <td align=center><%= m_route_area.tree_no %></td>
              <% if current_user.authority!=9 %>
                <td align=center><input type=button value="編集" onClick="f_route_area_submit(2,<%= m_route_area.tree_no %>);" class='btn btn-mini'></td>
                <% @url_path = "?routecode=" + ERB::Util.url_encode(params[:routecode].to_s) + "&hold_params=1&search_page=" + params[:search_page].to_s + "search_routecode=" + ERB::Util.url_encode(params[:search_routecode].to_s) + "&search_routename=" + ERB::Util.url_encode(params[:search_routename].to_s) + "&search_itaku=" + ERB::Util.url_encode(params[:search_itaku].to_s) + "&search_delete=" + params[:search_delete].to_s %>
                <td align=center><%= link_to '削除', 'm_route_areas/'+m_route_area.id.to_s+ @url_path.to_s, method: :delete, data: { confirm: '削除しますがよろしいですか?' }, :style=>"color:white;", :class => 'btn btn-mini btn-danger' %></td>
              <% end %>
              <input type=hidden id=latlng_<%= m_route_area.tree_no %> name=latlng_<%= m_route_area.tree_no %> value="<%= m_route_area.latlng %>">
            </tr>
          <% end %>
        </tbody>
      </table>
      <br>
      <% if current_user.authority!=9 %>
        <input type=button value="追加" onClick="f_route_area_submit(1,0);" class='btn btn-primary'>&nbsp;&nbsp;
      <% end %>
      <%= link_to '戻る', m_routes_path(:hold_params=>1,:page=>params[:search_page].to_s,:search_routecode=>params[:search_routecode].to_s,:search_routename=>params[:search_routename].to_s,:search_itaku=>params[:search_itaku].to_s,:search_delete=>params[:search_delete].to_s), :class => 'btn' %>
      <%= form_tag("m_route_areas", method: "post", id: "input_form", name: "input_form") do %>
        <input type=hidden name=upd_flg id=upd_flg>
        <input type=hidden name=tree_no id=tree_no>
        <input type=hidden name=routecode value="<%= params[:routecode] %>">
        <%= hidden_field_tag :hold_params, 1 %>
        <%= hidden_field_tag :search_page, params[:search_page].to_s %>
        <%= hidden_field_tag :search_routecode, params[:search_routecode].to_s %>
        <%= hidden_field_tag :search_routename, params[:search_routename].to_s %>
        <%= hidden_field_tag :search_itaku, params[:search_itaku].to_s %>
        <%= hidden_field_tag :search_delete, params[:search_delete].to_s %>
      <% end %>
    </td>
    <td valign=top width=80%>
      <div class="map_container">
        <div id="map_canvas" style="width:100%; height:500px"></div>
      </div>
    </td>
  </tr>
</table>



<% content_for :scripts do %>
  <script src="//maps.googleapis.com/maps/api/js?language=ja&key=<%= @map_key %>"></script>
  <script src="//google-maps-utility-library-v3.googlecode.com/svn/tags/markerclustererplus/2.0.14/src/markerclusterer_packed.js" type="text/javascript"></script>
  <script type="text/javascript" charset="utf-8">
    var latlngData2;
    var arrCoords2;
    var marker= new Array();
    var infowindow = new Array();
    var myLatlng;
    var seq_id = 0;
    var icon = "images/marker_icon.png";

    var poly2;
    var poly_color = poly_color_code[0];

    <% if not @m_route.area_color_value.blank? %>
      poly_color = "<%= @m_route.area_color_value.to_s %>";
    <% end %>
    
    var lat = <%= @def_lat %>;
    var lng = <%= @def_lng %>;
    var mapOptions = {
      zoom: 15,
      center: new google.maps.LatLng(lat, lng),
      gestureHandling: "greedy",
      mapTypeId: google.maps.MapTypeId.ROADMAP,
      scaleControl: true
    };
    var map = new google.maps.Map(document.getElementById('map_canvas'), mapOptions);
    
<%
  if not @m_route_points.nil?
    @m_route_points.each do |m_route_point|
%>
      myLatlng = new google.maps.LatLng(<%= m_route_point.latitude.to_s %>,<%= m_route_point.longitude.to_s %>);
      contentString = "<div style='width:400px; height:50px;'><h3>" + "<%= m_route_point.cust_code.to_s %>" + ":" + "<%= m_route_point.cust_name.to_s %>" + "</h3>";
      contentString = contentString + "</div>";
      
      infowindow[seq_id] = new google.maps.InfoWindow({
        content: contentString,
        disableAutoPan: true
      });
      marker[seq_id] = new google.maps.Marker({
        position: myLatlng,
        icon: icon,
        map: map,
        title: seq_id+''
      });
      google.maps.event.addListener(marker[seq_id], 'click', function() {
        //情報ウィンドウ閉じる
        for(var i = 0; i < seq_id; i++){
          infowindow[i].close();
        }
        infowindow[this.getTitle()].open(map,marker[this.getTitle()]);
      });
      seq_id = seq_id + 1;
<%
    end
  end
%>
    
    function f_route_area_submit(upd_flg, tree_no){
      document.getElementById("upd_flg").value=upd_flg;
      document.getElementById("tree_no").value=tree_no;
      $("#input_form").submit();
    }
    
    //一覧選択時のイベント
    var gActiveobj;
    function mouseOverTR( obj ) {
      for (var i=0;i<obj.cells.length;i++ ) {
        obj.cells[i].style.backgroundColor = "#FFFF55";
      }
    }
    function mouseOutTR( obj ) {
      if (obj!=gActiveobj){
        for (var i=0;i<obj.cells.length;i++ ) {
          obj.cells[i].style.backgroundColor = "";
        }
      }
    }
    function mClickTR(obj, tree_no) {
      
      if (gActiveobj){
        for(var i=0;i<gActiveobj.cells.length;i++ ){
          gActiveobj.cells[i].style.backgroundColor = "";
        }
      }
      gActiveobj = obj;
      for(var i=0;i<obj.cells.length;i++){
        obj.cells[i].style.backgroundColor = "#FFFF55";
      }
      //ポリゴン再表示
      latlngData2 = (new Function("return " + "[" + document.getElementById("latlng_"+tree_no).value + "]"))();
      arrCoords2 = new Array();  
      //既に存在していたら削除
      if(poly2){
        poly2.setMap(null);
      }
      for (i = 0;i < latlngData2.length;i++) {  
        // 座標地をlatlng値に変換  
        var latlng2 = new google.maps.LatLng(latlngData2[i].lat, latlngData2[i].lng);  
        // latlng値を配列に退避  
        arrCoords2.push(latlng2);
        //１件目の緯度経度へマップ位置移動
        if(i==0){
          var pos = new google.maps.LatLng(latlngData2[i].lat,latlngData2[i].lng);
          map.panTo(pos);
        }
      }
      // ポリゴン(多角形)を生成し、マップに表示
      poly2 = new google.maps.Polygon({  
        map: map,              //マップ  
        paths: arrCoords2,     //閉ループを示す座標列  
        strokeWeight: 2,       //ストローク幅(ピクセル単位)  
        strokeColor: poly_color,//ストロークの色(16進数形式)  
        strokeOpacity: 1,    //ストロークの不透明度  
        fillColor: poly_color,  //塗りつぶしの色(16進数形式)  
        fillOpacity: 0.05       //塗りつぶしの不透明度(0.0～1.0)  
      });
      poly2.setMap(map);
    }
  </script>
<% end %>
